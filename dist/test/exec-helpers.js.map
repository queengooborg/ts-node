{"version":3,"file":"exec-helpers.js","sourceRoot":"","sources":["../../src/test/exec-helpers.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  ChildProcess,\n  ExecException,\n  ExecOptions,\n  SpawnOptions,\n} from 'child_process';\nimport {\n  exec as childProcessExec,\n  spawn as childProcessSpawn,\n} from 'child_process';\nimport { getStream } from './helpers';\nimport { expect } from './testlib';\n\nexport type ExecReturn = Promise<ExecResult> & { child: ChildProcess };\nexport interface ExecResult {\n  stdout: string;\n  stderr: string;\n  err: null | ExecException;\n  child: ChildProcess;\n}\n\nexport function createExec<T extends Partial<ExecOptions>>(\n  preBoundOptions?: T\n) {\n  /**\n   * Helper to exec a child process.\n   * Returns a Promise and a reference to the child process to suite multiple situations.\n   * Promise resolves with the process's stdout, stderr, and error.\n   */\n  return function exec(\n    cmd: string,\n    opts?: Pick<ExecOptions, Exclude<keyof ExecOptions, keyof T>> &\n      Partial<Pick<ExecOptions, keyof T & keyof ExecOptions>>\n  ): ExecReturn {\n    let child!: ChildProcess;\n    return Object.assign(\n      new Promise<ExecResult>((resolve, reject) => {\n        child = childProcessExec(\n          cmd,\n          {\n            ...preBoundOptions,\n            ...opts,\n          },\n          (err, stdout, stderr) => {\n            resolve({ err, stdout, stderr, child });\n          }\n        );\n      }),\n      {\n        child,\n      }\n    );\n  };\n}\n\nexport type SpawnReturn = Promise<SpawnResult> & { child: ChildProcess };\nexport interface SpawnResult {\n  stdoutP: Promise<string>;\n  stderrP: Promise<string>;\n  code: number | null;\n  child: ChildProcess;\n}\n\nexport function createSpawn<T extends Partial<SpawnOptions>>(\n  preBoundOptions?: T\n) {\n  /**\n   * Helper to spawn a child process.\n   * Returns a Promise and a reference to the child process to suite multiple situations.\n   *\n   * Should almost always avoid this helper, and instead use `createExec` / `exec`.  `spawn`\n   * may be necessary if you need to avoid `exec`'s intermediate shell.\n   */\n  return function spawn(\n    cmd: string[],\n    opts?: Pick<SpawnOptions, Exclude<keyof SpawnOptions, keyof T>> &\n      Partial<Pick<SpawnOptions, keyof T & keyof SpawnOptions>>\n  ) {\n    let child!: ChildProcess;\n    return Object.assign(\n      new Promise<SpawnResult>((resolve, reject) => {\n        child = childProcessSpawn(cmd[0], cmd.slice(1), {\n          ...preBoundOptions,\n          ...opts,\n        });\n        const stdoutP = getStream(child.stdout!);\n        const stderrP = getStream(child.stderr!);\n        child.on('exit', (code) => {\n          resolve({ stdoutP, stderrP, code, child });\n        });\n        child.on('error', (error) => {\n          reject(error);\n        });\n      }),\n      {\n        child,\n      }\n    );\n  };\n}\n\nconst defaultExec = createExec();\nexport { defaultExec as exec };\n\nexport interface ExecTesterOptions {\n  cmd: string;\n  flags?: string;\n  env?: Record<string, string>;\n  stdin?: string;\n  expectError?: boolean;\n  exec?: typeof defaultExec;\n}\n\n/**\n * Create a function that launches a CLI command, optionally pipes stdin, optionally sets env vars,\n * optionally runs a couple baked-in assertions, and returns the results for additional assertions.\n */\nexport function createExecTester<T extends Partial<ExecTesterOptions>>(\n  preBoundOptions: T\n) {\n  return async function (\n    options: Pick<\n      ExecTesterOptions,\n      Exclude<keyof ExecTesterOptions, keyof T>\n    > &\n      Partial<Pick<ExecTesterOptions, keyof T & keyof ExecTesterOptions>>\n  ) {\n    const {\n      cmd,\n      flags = '',\n      stdin,\n      expectError = false,\n      env,\n      exec = defaultExec,\n    } = {\n      ...preBoundOptions,\n      ...options,\n    };\n    const execPromise = exec(`${cmd} ${flags}`, {\n      env: { ...process.env, ...env },\n    });\n    if (stdin !== undefined) {\n      execPromise.child.stdin!.end(stdin);\n    }\n    const { err, stdout, stderr } = await execPromise;\n    if (expectError) {\n      expect(err).toBeDefined();\n    } else {\n      expect(err).toBeNull();\n    }\n    return { stdout, stderr, err };\n  };\n}\n"]}